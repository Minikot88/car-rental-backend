generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

//////////////////////////////////////////////////////
// USER
//////////////////////////////////////////////////////

model User {
  id         Int      @id @default(autoincrement())
  username   String   @unique
  name       String
  surname    String
  address    String
  phone      String   @unique
  password   String   @db.VarChar(255)

  role       Role     @default(USER)
  status     String   @default("active")

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  deletedAt  DateTime?

  reservations   Reservation[]
  notifications  Notification[]
  logs           Log[]
  reviews        Review[]
  discountUsages DiscountUsage[]

  @@index([role])
  @@index([status])
  @@index([deletedAt])
}

//////////////////////////////////////////////////////
// CAR
//////////////////////////////////////////////////////

model Car {
  id           Int           @id @default(autoincrement())

  name         String
  brand        String
  model        String
  year         Int           @db.SmallInt
  color        String?

  transmission Transmission
  seats        Int
  category     CarCategory
  fuelType     FuelType
  mileage      Int?

  pricePerDay  Float
  deposit      Float?

  image        String?
  images       String[]
  description  String?
  features     String[]

  status       CarStatus     @default(AVAILABLE)
  location     String?
  deletedAt    DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  reservations Reservation[]
  reviews      Review[]

  @@index([status])
  @@index([category])
  @@index([deletedAt])
}

//////////////////////////////////////////////////////
// RESERVATION
//////////////////////////////////////////////////////

model Reservation {
  id              Int               @id @default(autoincrement())

  userId          Int
  carId           Int

  startDate       DateTime
  endDate         DateTime

  totalPrice      Float
  status          ReservationStatus @default(PENDING)

  pickupLocation  String
  dropoffLocation String
  pickupTime      DateTime?
  dropoffTime     DateTime?

  discountId      Int?
  discountAmount  Float?

  lockExpiresAt   DateTime?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  deletedAt       DateTime?

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  car             Car               @relation(fields: [carId], references: [id], onDelete: Cascade)
  payment         Payment?
  discount        Discount?         @relation(fields: [discountId], references: [id])
  
  checkinCheckout CheckinCheckout?

  @@index([carId, startDate, endDate])
  @@index([status, lockExpiresAt])
  @@index([carId, status, deletedAt])
  @@index([deletedAt])
}

model CheckinCheckout {
  id             Int      @id @default(autoincrement())
  reservationId  Int      @unique
  checkInTime    DateTime?
  checkOutTime   DateTime?
  fuelLevel      String?
  mileageBefore  Int?
  mileageAfter   Int?
  beforePhotos   String[]
  afterPhotos    String[]
  damageReport   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
}



//////////////////////////////////////////////////////
// PAYMENT
//////////////////////////////////////////////////////

model Payment {
  id            Int           @id @default(autoincrement())

  reservationId Int           @unique
  amount        Float

  method        PaymentMethod
  status        PaymentStatus @default(PENDING)

  omiseChargeId String? @unique
  gateway       String?
  transactionId String?

  paidAt        DateTime?

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  reservation   Reservation   @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([transactionId])
}

//////////////////////////////////////////////////////
// DISCOUNT
//////////////////////////////////////////////////////

model Discount {
  id            Int        @id @default(autoincrement())
  code          String     @unique

  type          DiscountType
  value         Float
  maxDiscount   Float?
  minSpend      Float?

  usageLimit    Int?
  usedCount     Int        @default(0)
  perUserLimit  Int?

  startDate     DateTime?
  endDate       DateTime?

  isActive      Boolean    @default(true)

  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  reservations  Reservation[]
  usages        DiscountUsage[]

  @@index([isActive])
  @@index([startDate, endDate])
}

model DiscountUsage {
  id          Int      @id @default(autoincrement())
  discountId  Int
  userId      Int
  usedCount   Int      @default(0)

  discount    Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([discountId, userId])
}

//////////////////////////////////////////////////////
// REVIEW
//////////////////////////////////////////////////////

model Review {
  id        Int      @id @default(autoincrement())
  userId    Int
  carId     Int
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  deletedAt DateTime?

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  car       Car      @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@unique([userId, carId])
  @@index([carId])
  @@index([deletedAt])
}

//////////////////////////////////////////////////////
// NOTIFICATION
//////////////////////////////////////////////////////

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
}

//////////////////////////////////////////////////////
// LOG
//////////////////////////////////////////////////////

model Log {
  id        Int      @id @default(autoincrement())
  userId    Int?
  action    String
  detail    String?
  createdAt DateTime @default(now())

  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([createdAt])
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

enum Role {
  USER
  ADMIN
}

enum ReservationStatus {
  PENDING          // สร้างแล้ว รอจ่าย
  WAITING_PAYMENT  // ล็อครถไว้ รอชำระ
  CONFIRMED        // จ่ายแล้ว
  CANCELLED
  COMPLETED
  EXPIRED          // หมดเวลาชำระ
}


enum PaymentMethod {
  CASH
  TRANSFER
  CREDIT_CARD
  QR
}

enum PaymentStatus {
  PENDING //รอดำเนินการ
  WAITING_VERIFY   // ลูกค้ากดยืนยันแล้ว รอแอดมินเช็ค
  PAID //จ่ายแล้ว
  FAILED //ล้มเหลว
  REFUNDED //คืนเงินแล้ว
  EXPIRED //หมดอายุแล้ว
}


enum Transmission {
  AUTO
  MANUAL
}

enum CarCategory {
  SEDAN
  SUV
  VAN
  PICKUP
  HATCHBACK
  EV
}

enum FuelType {
  GASOLINE
  DIESEL
  HYBRID
  ELECTRIC
}

enum CarStatus {
  AVAILABLE
  BOOKED
  MAINTENANCE
}

enum DiscountType {
  PERCENT
  FIXED
}